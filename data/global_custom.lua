--game_items = {2388,2380,2386,2387,2429,2378,2381,2441,8293,2440,2427,2432,2431,2454,3962,2430,7436,2428,6553,7413,2435,8601,7454,7411,7380,7389,7453,7412,2443,7455,7434,2415,2447,7388,7456,8925,8924,8926,7435,7433,2382,2416,2401,2448,7379,2449,2436,2398,2437,2417,3966,7381,2422,2423,2321,2394,7432,3961,2434,7431,7426,7452,2391,7387,7421,2439,2421,7410,2452,8927,7428,7392,7429,2424,2453,2444,8929,8928,7427,7437,7392,2445,7414,7424,7425,7415,7423,7450,7451,7422,2652,2654,2655,2653,6095,2467,2651,2484,2650,2485,7463,8872,2464,2508,8868,8869,2483,8867,2465,7897,2489,2463,7898,2476,3968,7884,7899,8880,2505,8865,2503,8886,8866,8883,8885,8878,8882,2500,2492,8877,8892,2487,2494,2472,8881,8887,8884,8879,2466,8889,2656,8888,9776,8891,8890,2486,2642,7457,9931,2641,2643,3982,5462,2195,7886,7892,2645,2646,7893,7891,7459,2461,5917,7458,3971,2482,5741,6096,2458,2460,2480,2481,5924,2459,2502,7903,2473,2479,2490,2457,5461,2506,2462,2475,7939,3969,2496,9778,3972,7462,2474,7901,2498,7461,7902,2499,2491,2471,2493,2497,2342,2343,9928,3983,5918,2649,2468,7730,2648,2478,8923,2469,7896,2647,2504,9777,7885,2507,2477,7895,2488,2495,2470,7894,9928,3983,5918,2649,2468,7730,2648,2478,8923,2469,7896,2647,2504,9777,7885,2507,2477,7895,2488,2495,2470,7894,3975,3974,2512,2541,3973,2526,2530,2531,2513,2509,2510,2525,2511,2527,2540,2535,2538,6433,2528,7460,6131,2516,2521,2533,2532,2515,2524,6391,2518,2529,2542,2536,2534,2514,2523,2539,2520,2522,2519,2537,2517,2403,2379,2404,2402,2420,2384,2411,2376,2406,5908,2450,2351,2412,2377,2385,2438,2395,7385,7383,2397,8209,2419,2442,7384,7390,2393,2413,7404,7386,2409,7416,2383,7382,7418,2451,2392,2407,7405,7408,8602,2400,7417,7406,8930,2390,7403,7391,7402,7407,8932,2446,7449,2408,8931,6528,7959}

shop_items = {2390,2469,2496,5903,2471,2522,8882,2517,2421,2644,7455,8886,8926,7420,11118,7433,8884,2495,7435,2446,2659,15407,8906,8907,8905,8908,8909,11117,2646,15412,18465,2539,8929,2447,7458,12644,15413,7431,8888,2139,12645,15410,8930,8881,12630,7411,6391,12642,15408,6433,8924,8890,7417,8928,2503,18403,6132,18410,8879,12643,7412,12649,6553,2431,8885,8867,2400,2494,2452,15404,12607,2472,8883,15411,7382,6101,7414,7429,2504,2502,2342,9778,9932,11240,9777,9776,7391,7390,2444,7410,7453,7388,6531,7434,2514,7403,7415,7419,15492,15409,12646,7416,7418,2492,11302,2493,7856,7871,7746,7765,6528,11307,2453,7866,7881,7756,7775,7422,7421,7861,7876,7751,7770,11355,8880,15490,3972,5741,7384,7389,7404,7855,7870,7745,7764,7386,7383,7899,11356,2470,7895,7894,2645,2414,2498,2535,2520,2466,15491,7424,2195,7402,7436,7898,8889,7885,2662,10570,2393,7407,11306,3966,7456,7413,8878,8891,2655,7884,11301,2488,7896,11304,7893,2534,7437,7730,7858,7873,7748,7767,7426,7451,7863,7878,7753,2427,7772,2656,15489,2487,7897,3983,10016,11368,2519,2536,2407,7427,2432,15451,9929,9928,9927,7459,9931,5462,7886,2528,7463,15453,7406,2392,7392,2436,3962,8871,2497,2475,0,7902,5461,7901,7900,7903,11303,7452,2476,2477,7891,2516,2396,7430,2435,7454,8873,2491,7892,23529,2434,2430,2323,6096,2518,2515,7385,7408,7387,2425,11323,2486,6095,2663,3967,7457,2533,2426,2462,2532,7449,2383,7379,7432,7860,7875,7750,13838,7769,8870,5918,2480,2540,7869,7744,7763,2409,8892,7464,7460,7868,7883,7758,7777,7381,2391,2413,7854,2402,2440,8872,3968,8923,2479,3982,3970,2463,2529,2489,2429,7859,7874,7749,7768,2457,2423,7864,7879,7754,7773,2321,7425,2428,3964,2647,2521,2525,6131,2377,2465,3963,2387,2381,7462,2417,2378,3969,3975,2416,2531,2422,2464,2478,2419,3974,2395,2442,2449,2394,2481,2513,2648,2541,2509,2483,2473,2397,2411,2510,2420,2511,2398,2376,2388,2652,2484,2450,2385,2406,2448,2467,2649,2643,2512,2654,2384,2485,2379,2404,2651,2650}
shop_prices = {[2390]=750000000,[2469]=500000000,[2496]=400000000,[5903]=300000000,[2471]=160000000,[2522]=100000000,[8882]=50000000,[2517]=50000000,[2421]=40000000,[2644]=40000000,[7455]=30000000,[8886]=30000000,[8926]=25000000,[7420]=20000000,[11118]=20000000,[7433]=15000000,[8884]=15000000,[2495]=12000000,[7435]=11000000,[2446]=10000000,[2659]=10000000,[15407]=10000000,[8906]=10000000,[8907]=10000000,[8905]=10000000,[8908]=10000000,[8909]=10000000,[11117]=8000000,[2646]=8000000,[15412]=5000000,[18465]=4500000,[2539]=4500000,[8929]=4000000,[2447]=3000000,[7458]=3000000,[12644]=3000000,[15413]=2000000,[7431]=1500000,[8888]=1500000,[2139]=1200000,[12645]=1100000,[15410]=1000000,[8930]=900000,[8881]=900000,[12630]=900000,[7411]=800000,[6391]=750000,[12642]=700000,[15408]=700000,[6433]=650000,[8924]=600000,[8890]=600000,[7417]=500000,[8928]=500000,[2503]=500000,[18403]=500000,[6132]=500000,[18410]=500000,[8879]=450000,[12643]=440000,[7412]=340000,[12649]=300000,[6553]=300000,[2431]=300000,[8885]=300000,[8867]=300000,[2400]=250000,[2494]=250000,[2452]=200000,[15404]=200000,[12607]=200000,[2472]=200000,[8883]=200000,[15411]=200000,[7382]=150000,[6101]=150000,[7414]=150000,[7429]=150000,[2504]=150000,[2502]=150000,[2342]=150000,[9778]=150000,[9932]=150000,[11240]=150000,[9777]=120000,[9776]=115000,[7391]=100000,[7390]=100000,[2444]=100000,[7410]=100000,[7453]=100000,[7388]=100000,[6531]=95000,[7434]=85000,[2514]=85000,[7403]=80000,[7415]=80000,[7419]=80000,[15492]=80000,[15409]=80000,[12646]=70000,[7416]=60000,[7418]=60000,[2492]=60000,[11302]=60000,[2493]=55000,[7856]=50000,[7871]=50000,[7746]=50000,[7765]=50000,[6528]=50000,[11307]=50000,[2453]=50000,[7866]=50000,[7881]=50000,[7756]=50000,[7775]=50000,[7422]=50000,[7421]=50000,[7861]=50000,[7876]=50000,[7751]=50000,[7770]=50000,[11355]=50000,[8880]=50000,[15490]=50000,[3972]=50000,[5741]=50000,[7384]=45000,[7389]=45000,[7404]=40000,[7855]=40000,[7870]=40000,[7745]=40000,[7764]=40000,[7386]=40000,[7383]=40000,[7899]=40000,[11356]=40000,[2470]=40000,[7895]=40000,[7894]=40000,[2645]=40000,[2414]=35000,[2498]=35000,[2535]=35000,[2520]=35000,[2466]=32000,[15491]=32000,[7424]=30000,[2195]=30000,[7402]=25000,[7436]=25000,[7898]=25000,[8889]=25000,[7885]=25000,[2662]=25000,[10570]=25000,[2393]=20000,[7407]=20000,[11306]=20000,[3966]=20000,[7456]=20000,[7413]=20000,[8878]=20000,[8891]=20000,[2655]=20000,[7884]=20000,[11301]=20000,[2488]=20000,[7896]=20000,[11304]=20000,[7893]=20000,[2534]=20000,[7437]=18000,[7730]=17000,[7858]=15000,[7873]=15000,[7748]=15000,[7767]=15000,[7426]=15000,[7451]=15000,[7863]=15000,[7878]=15000,[7753]=15000,[2427]=15000,[7772]=15000,[2656]=15000,[15489]=15000,[2487]=15000,[7897]=15000,[3983]=15000,[10016]=15000,[11368]=15000,[2519]=15000,[2536]=15000,[2407]=12000,[7427]=12000,[2432]=12000,[15451]=11000,[9929]=10000,[9928]=10000,[9927]=10000,[7459]=10000,[9931]=10000,[5462]=10000,[7886]=10000,[2528]=10000,[7463]=9000,[15453]=9000,[7406]=8000,[2392]=8000,[7392]=8000,[2436]=8000,[3962]=8000,[8871]=8000,[2497]=8000,[2475]=8000,[0]=7000,[7902]=7000,[5461]=7000,[7901]=7000,[7900]=7000,[7903]=7000,[11303]=7000,[7452]=6000,[2476]=6000,[2477]=6000,[7891]=6000,[2516]=6000,[2396]=5000,[7430]=5000,[2435]=5000,[7454]=5000,[8873]=5000,[2491]=5000,[7892]=5000,[23529]=5000,[2434]=4000,[2430]=4000,[2323]=4000,[6096]=4000,[2518]=4000,[2515]=4000,[7385]=3000,[7408]=3000,[7387]=3000,[2425]=3000,[11323]=3000,[2486]=3000,[6095]=3000,[2663]=3000,[3967]=3000,[7457]=3000,[2533]=3000,[2426]=2500,[2462]=2500,[2532]=2100,[7449]=2000,[2383]=2000,[7379]=2000,[7432]=2000,[7860]=2000,[7875]=2000,[7750]=2000,[13838]=2000,[7769]=2000,[8870]=2000,[5918]=2000,[2480]=2000,[2540]=2000,[7869]=1500,[7744]=1500,[7763]=1500,[2409]=1500,[8892]=1500,[7464]=1500,[7460]=1500,[7868]=1200,[7883]=1200,[7758]=1200,[7777]=1200,[7381]=1200,[2391]=1200,[2413]=1000,[7854]=1000,[2402]=1000,[2440]=1000,[8872]=1000,[3968]=1000,[8923]=1000,[2479]=1000,[3982]=1000,[3970]=850,[2463]=800,[2529]=800,[2489]=600,[2429]=590,[7859]=590,[7874]=590,[7749]=590,[7768]=590,[2457]=580,[2423]=540,[7864]=540,[7879]=540,[7754]=540,[7773]=540,[2321]=500,[7425]=500,[2428]=500,[3964]=500,[2647]=500,[2521]=500,[2525]=500,[6131]=500,[2377]=450,[2465]=450,[3963]=400,[2387]=400,[2381]=400,[7462]=400,[2417]=350,[2378]=300,[3969]=300,[3975]=280,[2416]=260,[2531]=260,[2422]=200,[2464]=200,[2478]=195,[2419]=150,[3974]=120,[2395]=118,[2442]=100,[2449]=100,[2394]=100,[2481]=100,[2513]=95,[2648]=80,[2541]=80,[2509]=80,[2483]=75,[2473]=66,[2397]=51,[2411]=50,[2510]=45,[2420]=40,[2511]=40,[2398]=30,[2376]=25,[2388]=25,[2652]=25,[2484]=25,[2450]=20,[2385]=10,[2406]=10,[2448]=10,[2467]=10,[2649]=10,[2643]=10,[2512]=10,[2654]=9,[2384]=7,[2485]=3,[2379]=2,[2404]=1,[2651]=1,[2650]=1}

waypoints = {
	{name="Depths", x = 2258, y = 2245, z = 6},
	{name="Stone Hills", x = 2311, y = 2260, z = 6},
	{name="City Sewers", x = 2221, y = 2160, z = 7},
	{name="Rhaal Desert", x = 2513, y = 2113, z = 7},
	{name="Olxyr Jungle", x = 2601, y = 2156, z = 7},
	{name="Walk of Leagues", x = 2344, y = 2261, z = 8},
	{name="Old Tunnel Passing", x = 2212, y = 2206, z = 8},
	{name="Rushville", x = 2514, y = 2328, z = 7},
	{name="Infernal Pits", x = 2700, y = 2400, z = 14},
	{name= "Deeper Pits", x = 2922, y = 2446, z = 15},
	{name="Colossal Hills", x = 2241, y = 2456, z = 7},
	{name="Drahalee", x = 2455, y = 1926, z = 7},
	{name="Oil", x = 2655, y = 1972, z = 7},
	{name="Jungle 1", x = 2430, y = 1697, z = 7},
	{name= "Zhler Caves", x = 2564, y = 2268, z = 11},
	{name= "Jungle 2", x = 2324, y = 1678, z = 7},
	{name= "Vyln Caves", x = 2556, y = 2294, z = 8}
}

shop_tiles = {
	{x=2251,y=2246,z=7,stackpos=255},
	{x=2251,y=2245,z=7,stackpos=255},
	{x=2251,y=2244,z=7,stackpos=255},
	{x=2251,y=2243,z=7,stackpos=255},
	{x=2251,y=2242,z=7,stackpos=255},
	{x=2251,y=2241,z=7,stackpos=255},
	{x=2252,y=2241,z=7,stackpos=255},
	{x=2253,y=2241,z=7,stackpos=255},
	{x=2254,y=2241,z=7,stackpos=255},
	{x=2255,y=2241,z=7,stackpos=255},
	
	{x=2262,y=2244,z=7,stackpos=255},
	{x=2263,y=2244,z=7,stackpos=255},
	{x=2264,y=2244,z=7,stackpos=255},
	{x=2265,y=2244,z=7,stackpos=255},
	{x=2266,y=2244,z=7,stackpos=255},
	{x=2267,y=2244,z=7,stackpos=255},
	{x=2267,y=2245,z=7,stackpos=255},
	{x=2267,y=2246,z=7,stackpos=255},
	{x=2266,y=2246,z=7,stackpos=255},
	{x=2265,y=2246,z=7,stackpos=255},
	{x=2264,y=2247,z=7,stackpos=255},
	{x=2264,y=2248,z=7,stackpos=255},
	{x=2264,y=2249,z=7,stackpos=255},
	{x=2263,y=2249,z=7,stackpos=255},
	{x=2262,y=2249,z=7,stackpos=255}
}

function setItemName(uid,name)
	return Item(uid):setAttribute('name',name)
end
function setItemArmor(uid,name)
	return Item(uid):setAttribute('armor',name)
end
function setItemDefense(uid,name)
	return Item(uid):setAttribute('defense',name)
end
function setItemAttack(uid,name)
	return Item(uid):setAttribute('attack',name)
end
function getItemAttack(uid)
	return Item(uid):getType():getAttack()
end
function getItemDefense(uid)
	return Item(uid):getAttribute('defense')
end
function getItemArmor(uid)
	return Item(uid):getAttribute('armor')
end

function getPlayerWeapon(cid)
	local item_left = Player(cid):getSlotItem(CONST_SLOT_LEFT)
	local item_right = Player(cid):getSlotItem(CONST_SLOT_RIGHT)
	if (item_left ~= nil) then
		local wep_type = item_left:getType():getWeaponType()
		if (wep_type > 0 and wep_type < 7 and wep_type ~= WEAPON_SHIELD) then
			return item_left
		end
	elseif (item_right ~= nil) then
		local wep_type = item_right:getType():getWeaponType()
		if (wep_type > 0 and wep_type < 7 and wep_type ~= WEAPON_SHIELD) then
			return item_right
		end
	end
	return false
end

function deepcopy(orig)
    local orig_type = type(orig)
    local copy
    if orig_type == 'table' then
        copy = {}
        for orig_key, orig_value in next, orig, nil do
            copy[deepcopy(orig_key)] = deepcopy(orig_value)
        end
        setmetatable(copy, deepcopy(getmetatable(orig)))
    else -- number, string, boolean, etc
        copy = orig
    end
    return copy
end

function createShopItem(pos, level_max)
	doCleanTile(pos,false)

	--print (shop_items[2390])
	local item_id = shop_items[math.random(1, #shop_items)]
	--local price = shop_prices[key]
	--local itens = math.random(1,#game_items)
	--local info = ItemType(game_items[itens])
	-- while true do
	-- 	if (((info:getAttack() > level_max) or (info:getArmor() > level_max)) or ((info:getDefense() > level_max) and (info:getAttack() == 0))) then
	-- 		itens = math.random(1,#game_items)
	-- 		info = ItemType(game_items[itens])
	-- 		break
	-- 	end
	-- end
	local item = Game.createItem(item_id, 1, pos)
	--local item = Item(pos)
	--local a = {attack = getItem.attack or 0,defense = getItem.defense or 0,armor = getItem.armor or 0}
	doItemSetAttribute(item:getUniqueId(), 'aid', 2031)
	-- doItemSetAttribute(temp, 'attack', math.random(math.ceil(a.attack*0.8),math.ceil(a.attack*1.25)))
	-- doItemSetAttribute(temp, 'defense', math.random(math.ceil(a.defense*0.8),math.ceil(a.defense*1.25)))
	-- doItemSetAttribute(temp, 'armor', math.random(math.ceil(a.armor*0.8),math.ceil(a.armor*1.25)))

	-- setItemAttack(temp, math.random(math.ceil(a.attack*0.8),math.ceil(a.attack*1.25)))
	-- setItemDefense(temp, math.random(math.ceil(a.defense*0.8),math.ceil(a.defense*1.25)))
	-- setItemArmor(temp, math.random(math.ceil(a.armor*0.8),math.ceil(a.armor*1.25)))
end

function cost(item, level)
	local attack = item:getAttribute('attack') or 0
	local defense = item:getAttribute('defense') or 0
	local armor = item:getAttribute('armor') or 0
	local weaponType = item:getType():getWeaponType()
	print(tostring(item:getId()) .. " " .. attack .. " " .. defense .. " " .. armor)
	if((weaponType == WEAPON_AXE or weaponType == WEAPON_SWORD or weaponType == WEAPON_CLUB)) then
		local general_cost = attack * 65 * 0.4 + level*level/1.5 * 35 * 0.1
		local cost_item = math.ceil(general_cost * 0.7) --convenience fee? :P balance out user choice to upgrade weapon over all other armors.
		return cost_item
	elseif (weaponType == WEAPON_DISTANCE) or (weaponType == 7) then --BOW
		local general_cost = attack * 65 * 0.4 + level*level/1.5 * 35 * 0.1
		local cost_item = math.ceil(general_cost * 0.7)
		return cost_item
	elseif (armor > 0) then --ARMORS
		local general_cost = armor * 65 * 0.1 + level*level/1.5 * 35 * 0.1
		local cost_item = math.ceil(general_cost * 0.7)
		return cost_item
	elseif (weaponType == WEAPON_SHIELD) then --SHIELD
		local general_cost = defense * 65 * 0.2 + level*level/1.5 * 35 * 0.1
		local cost_item = math.ceil(general_cost * 0.7) --convenience fee? :P balance out user choice to upgrade weapon over all other armors.
		return cost_item
	else
		return 0
	end
end

function isArmor(uid) -- Function by Mock the bear.
    if (getItemInfo(uid.itemid).armor ~= 0) and (getItemWeaponType(uid.uid) == 0) then
		return true
	end
	return false
end
function isWeapon(uid) -- Function by Mock the bear.
	uid = uid or 0
	local f = getItemWeaponType(uid)
	if f == WEAPON_SWORD or f == WEAPON_CLUB or f == WEAPON_AXE then
		return true
	end
	return false
end
function isShield(uid) -- Function by Mock the bear.
	uid = uid or 0
	if getItemWeaponType(uid) == WEAPON_SHIELD then
		return true
	end
	return false
end
function isBow(uid) -- Function by Mock the bear.
	uid = uid or 0
	if getItemWeaponType(uid) == WEAPON_DIST then
		return true
	end
	return false
end

function deSpy(cid)
	if isPlayer(cid) then
		local old_pos = {x=tonumber(getCreatureStorage(cid, 1702)), y=tonumber(getCreatureStorage(cid, 1703)), z=tonumber(getCreatureStorage(cid, 1704))}
		if (old_pos.x > -1 and old_pos.y > -1 and old_pos.z > -1) then
			doTeleportThing(cid, old_pos, false)
		end
		doPlayerSetGroupId(cid, tonumber(getCreatureStorage(cid, 1701)))
		doSendMagicEffect(getPlayerPosition(cid), 13)
		doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "You are no longer spying.")
		doCreatureSetStorage(cid, 1701, -1)
		doCreatureSetStorage(cid, 1702, -1)
		doCreatureSetStorage(cid, 1703, -1)
		doCreatureSetStorage(cid, 1704, -1)
	end
end

function isInArray(array, value, caseSensitive)
	if(caseSensitive == nil or caseSensitive == false) and type(value) == "string" then
		local lowerValue = value:lower()
		for _, _value in ipairs(array) do
			if type(_value) == "string" and lowerValue == _value:lower() then
				return true
			end
		end
	else
		for _, _value in ipairs(array) do
			if (value == _value) then return true end
		end
	end

	return false
end

function setHealingFormula(combat, type, minl, maxl, minm, maxm, min, max)
	local min, max = min or 0, max or 0
	return setCombatFormula(combat, type, 1, 0, 1, 0, minl, maxl, minm, maxm, min, max)
end

function setAttackFormula(combat, type, minl, maxl, minm, maxm, min, max)
	local min, max = min or 0, max or 0
	return setCombatFormula(combat, type, -1, 0, -1, 0, minl, maxl, minm, maxm, -min, -max)
end


-- Player must be offline for this to actually work
function doPlayerChangeName(current, new)
	db.query("UPDATE `players` SET name=\"" .. new .. "\" WHERE name=\"" .. current .. "\";")
	if (not getPlayerByName(current)) then
		return true
	else
		return false
	end
end

-- @params guild ID
function getGuildTag(gid)
	local resultId  = db.storeQuery("SELECT `tag` FROM `guilds` WHERE id=" .. tostring(gid) .. ";")
	local tag = result.getDataString("name")
	return tag
end

-- @params guild ID
function setGuildTag(gid, tag)
	db.query("UPDATE `guilds` SET tag=\"" .. tag .. "\" WHERE id=" .. tostring(gid) .. ";")
end

-- tag outfits
red = {lookType = 128, lookHead = 113,lookBody = 113,lookLegs = 113,lookFeet = 95,lookAddons = 0} -- it
blue = {lookType = 128, lookHead = 88,lookBody = 88,lookLegs = 88,lookFeet = 95,lookAddons = 0} -- not it

function isArmor(item)
    if (item:getAttribute("armor") ~= 0) and (item:getType():getWeaponType() == WEAPON_NONE) then
		return true
	end
	return false
end
function isWeapon(item)
	local f = item:getType():getWeaponType()
	if f == WEAPON_SWORD or f == WEAPON_CLUB or f == WEAPON_AXE then
		return true
	end
	return false
end
function isBow(item)
	if item:getType():getWeaponType() == WEAPON_DIST then
		return true
	end
	return false
end
function isShield(item)
	if item:getType():getWeaponType() == WEAPON_SHIELD then
		return true
	end
	return false
end
function isWand(item)
	if item:getType():getWeaponType() == WEAPON_WAND then
		return true
	end
	return false
end

function getBow(cid)
	local rh = getPlayerSlotItem(cid, CONST_SLOT_RIGHT) or false
	local lh = getPlayerSlotItem(cid, CONST_SLOT_LEFT) or false
	local bow = false
	if (rh.itemid > 0) and isBow(rh.uid) then
		--print(rh.itemid)
		bow = rh.uid
	elseif (lh.itemid > 0) and isBow(lh.uid) then
		--print(lh.itemid)
		bow = lh.uid
	end
	return bow
end
function getWand(cid)
	local wep = getPlayerWeapon(cid)
	if isWand(wep) then
		return wep
	end
	return false
end
function getAmmo(cid)
	local ammo = getPlayerSlotItem(cid, CONST_SLOT_AMMO) or false
	local arrows = false
	if (ammo.itemid > 0) then
		arrows = ammo.uid
	end
	return arrows
end

function getCreatures(pos, radius, hit_array)
	creatures = {}
	for x = pos.x-radius, pos.x+radius do
		for y = pos.y-radius, pos.y+radius do
			if not (x == pos.x and y == pos.y) then
				local newpos = {x=x, y=y,z=pos.z}
				local thing = getTopCreature(newpos)
				if isCreature(thing.uid) and not isNpc(thing.uid) then
					if not isInArray(hit_array, thing.uid) then
						table.insert(creatures, thing.uid)
					end
				end
			end
		end
	end
	return creatures
end

function fixOrphanSummon(cid)
	if not isPlayer(cid) then
		return
	end
	local summons = getCreatureSummons(cid)
	for i,v in ipairs(summons) do
		local p_pos = getPlayerPosition(cid)
		local c_pos = getPlayerPosition(v)
		local dis = getDistanceBetween(c_pos, p_pos)
		if (dis > 8) or (c_pos.z ~= p_pos.z) then
			doTeleportThing(v, p_pos)
			doSendMagicEffect(p_pos, 10)
		end
	end
	if #summons > 0 then
		addEvent(fixOrphanSummon, 5000, cid)
	end
end

local function exhaust(cid, storage, seconds)
	if((os.time() - getPlayerStorageValue(cid, storage)) >= length) or (getPlayerStorageValue(cid, storage) == 0) then
		setPlayerStorageValue(cid, storage, os.time())
		return true
	else
		local wait = (exhaust.length - (os.time() - getPlayerStorageValue(cid, exhaust.storage)))
		if wait >= 60 then
			doPlayerSendCancel(cid, "You must wait " ..round((wait/60),0).. " minute(s) to do this.")
		else
			doPlayerSendCancel(cid, "You must wait " ..round(wait,0).. " seconds to do this.")
		end
		return false
	end
end


